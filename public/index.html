<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Text Editor App</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-dark: #0d0d14;
      --bg-panel: #14141f;
      --bg-card: #1a1a2e;
      --border: #2a2a40;
      --text: #e0e0e0;
      --text-muted: #888;
      --accent: #ff6600;
      --accent-hover: #ff8533;
      --success: #00cc66;
    }

    body {
      font-family: 'Space Grotesk', system-ui, sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      min-height: 100vh;
      display: flex;
    }

    /* Sidebar */
    .sidebar {
      width: 320px;
      background: var(--bg-panel);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--accent), #ff3366);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .folder-input {
      display: flex;
      gap: 8px;
    }

    .folder-input input {
      flex: 1;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px 14px;
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
    }

    .folder-input input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .folder-input input::placeholder {
      color: var(--text-muted);
    }

    .btn {
      background: var(--accent);
      border: none;
      color: white;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-family: inherit;
      font-size: 13px;
      font-weight: 500;
      transition: background 0.2s;
    }

    .btn:hover {
      background: var(--accent-hover);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .current-project {
      margin-top: 12px;
      padding: 10px;
      background: var(--bg-dark);
      border-radius: 6px;
      font-size: 11px;
      color: var(--text-muted);
      font-family: 'JetBrains Mono', monospace;
      word-break: break-all;
      display: none;
    }

    .current-project.active {
      display: block;
    }

    .current-project .label {
      color: var(--success);
      margin-bottom: 4px;
    }

    /* File list */
    .file-list {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }

    .file-list h3 {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      margin-bottom: 12px;
      padding: 0 8px;
    }

    .file-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      padding-left: 8px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
      user-select: none;
    }

    .file-item:hover {
      background: var(--bg-card);
    }

    .file-item.active {
      background: var(--accent);
    }

    .file-item.folder {
      font-weight: 500;
    }

    .file-item .icon {
      font-size: 14px;
      width: 16px;
      text-align: center;
      flex-shrink: 0;
    }

    .file-item .expand-icon {
      font-size: 10px;
      width: 12px;
      text-align: center;
      flex-shrink: 0;
      transition: transform 0.2s;
      color: var(--text-muted);
    }

    .tree-item.expanded .expand-icon {
      transform: rotate(90deg);
    }

    .file-item .name {
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }

    .tree-item {
      margin-left: 0;
    }

    .tree-item.folder-item {
      margin-bottom: 2px;
    }

    .tree-item .tree-children {
      margin-left: 20px;
      display: none;
      border-left: 1px solid var(--border);
      margin-left: 16px;
      padding-left: 8px;
    }

    .tree-item.expanded .tree-children {
      display: block;
    }

    .tree-item.expanded > .file-item.folder {
      color: var(--accent);
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Main content */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .toolbar {
      padding: 12px 20px;
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .toolbar .file-name {
      font-weight: 500;
      font-size: 14px;
    }

    .toolbar .hint {
      color: var(--text-muted);
      font-size: 12px;
    }
    
    .toolbar .hint.modified {
      color: #ffcc00;
    }
    
    .toolbar-actions .btn.active {
      background: var(--success);
    }
    
    .toolbar-actions .btn.active:hover {
      background: #00aa55;
    }

    .toolbar .hint kbd {
      background: var(--bg-dark);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
    }

    .preview-container {
      flex: 1;
      background: white;
      position: relative;
    }

    .preview-container iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .welcome-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      background: var(--bg-dark);
      text-align: center;
      padding: 40px;
    }

    .welcome-screen .icon {
      font-size: 64px;
      margin-bottom: 24px;
    }

    .welcome-screen h2 {
      font-size: 24px;
      margin-bottom: 12px;
    }

    .welcome-screen p {
      color: var(--text-muted);
      max-width: 400px;
      line-height: 1.6;
    }

    .welcome-screen .steps {
      margin-top: 32px;
      text-align: left;
    }

    .welcome-screen .step {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      color: var(--text-muted);
    }

    .welcome-screen .step .num {
      width: 28px;
      height: 28px;
      background: var(--bg-card);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 13px;
      color: var(--accent);
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-dark);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #3a3a50;
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <div class="logo-icon">üìù</div>
        <span>Text Editor</span>
      </div>
      
      <div class="folder-input">
        <input type="text" id="folder-path" placeholder="/cesta/ke/slo≈æce">
        <button class="btn" id="load-btn">Naƒç√≠st</button>
      </div>
      
      <div class="current-project" id="current-project">
        <div class="label">‚úì Aktivn√≠ projekt:</div>
        <div class="path"></div>
      </div>
    </div>
    
    <div class="file-list" id="file-list">
      <div class="empty-state">
        <div class="icon">üìÅ</div>
        <p>Zadej cestu ke slo≈æce s projektem a klikni na "Naƒç√≠st"</p>
      </div>
    </div>
  </aside>
  
  <main class="main">
    <div class="toolbar" id="toolbar" style="display: none;">
      <span class="file-name" id="current-file">-</span>
      <div class="toolbar-actions" id="toolbar-actions" style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
        <button class="btn" id="edit-mode-btn-main" style="padding: 6px 14px; font-size: 13px;">‚úèÔ∏è Edit m√≥d</button>
        <span style="width: 1px; height: 20px; background: var(--border);"></span>
        <span class="hint" id="edit-status-main" style="font-size: 12px; color: var(--text-muted);">P≈ôipraveno</span>
        <span class="hint" style="font-size: 11px; color: var(--text-muted); padding: 4px 8px; background: rgba(255,255,255,0.05); border-radius: 4px;" title="Nedƒõliteln√° mezera = Ctrl+Shift+Space">nbsp: ‚åÉ‚áß‚ê£</span>
        <button class="btn" id="save-btn-main" style="padding: 6px 14px; font-size: 13px;">üíæ Ulo≈æit</button>
      </div>
    </div>
    
    <div class="preview-container" id="preview-container">
      <div class="welcome-screen" id="welcome">
        <div class="icon">‚ú®</div>
        <h2>V√≠tej v Text Editoru</h2>
        <p>Edituj texty na sv√Ωch webov√Ωch str√°nk√°ch p≈ô√≠mo v prohl√≠≈æeƒçi a ukl√°dej zmƒõny zpƒõt do soubor≈Ø.</p>
        
        <div class="steps">
          <div class="step">
            <div class="num">1</div>
            <span>Zadej cestu ke slo≈æce s projektem</span>
          </div>
          <div class="step">
            <div class="num">2</div>
            <span>Vyber HTML soubor ze seznamu</span>
          </div>
          <div class="step">
            <div class="num">3</div>
            <span>Zapni Edit m√≥d a klikni na text</span>
          </div>
          <div class="step">
            <div class="num">4</div>
            <span>Ctrl+S pro ulo≈æen√≠ zmƒõn</span>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <script>
    const folderInput = document.getElementById('folder-path');
    const loadBtn = document.getElementById('load-btn');
    const fileList = document.getElementById('file-list');
    const currentProject = document.getElementById('current-project');
    const previewContainer = document.getElementById('preview-container');
    const toolbar = document.getElementById('toolbar');
    const currentFileEl = document.getElementById('current-file');
    const welcome = document.getElementById('welcome');
    
    let currentFile = null;
    let iframe = null;

    // Naƒç√≠st aktu√°ln√≠ projekt p≈ôi startu
    async function loadCurrentProject() {
      try {
        const response = await fetch('/api/current-project');
        const data = await response.json();
        
        if (data.projectRoot) {
          folderInput.value = data.projectRoot;
          await loadFiles();
        }
      } catch (err) {
        console.error('Chyba p≈ôi naƒç√≠t√°n√≠ projektu:', err);
      }
    }

    // Nastavit projekt a naƒç√≠st soubory
    async function setProject() {
      const folder = folderInput.value.trim();
      
      if (!folder) {
        alert('Zadej cestu ke slo≈æce');
        return;
      }
      
      loadBtn.disabled = true;
      loadBtn.textContent = 'Naƒç√≠t√°m...';
      
      try {
        const response = await fetch('/api/set-project', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ folder })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error);
        }
        
        currentProject.classList.add('active');
        currentProject.querySelector('.path').textContent = data.path;
        
        await loadFiles();
      } catch (err) {
        alert('Chyba: ' + err.message);
      } finally {
        loadBtn.disabled = false;
        loadBtn.textContent = 'Naƒç√≠st';
      }
    }

    // Poƒç√≠tat HTML soubory v stromu
    function countFiles(node) {
      let count = 0;
      if (node.type === 'file') {
        count = 1;
      } else if (node.children) {
        node.children.forEach(child => {
          count += countFiles(child);
        });
      }
      return count;
    }

    // Renderovat stromovou strukturu
    function renderTree(node, level = 0) {
      if (node.type === 'file') {
        return `
          <div class="tree-item">
            <div class="file-item" data-path="${node.path}">
              <span class="icon">üìÑ</span>
              <span class="name">${node.name}</span>
            </div>
          </div>
        `;
      } else {
        // Filtrovat pouze slo≈æky a soubory, kter√© obsahuj√≠ HTML soubory
        const filteredChildren = node.children.filter(child => {
          if (child.type === 'file') return true;
          if (child.type === 'directory') {
            return countFiles(child) > 0; // Zobrazit pouze slo≈æky s HTML soubory
          }
          return false;
        });
        
        if (filteredChildren.length === 0) {
          return ''; // P≈ôeskoƒçit pr√°zdn√© slo≈æky
        }
        
        // Se≈ôadit dƒõti: index.html prvn√≠, pak ostatn√≠ soubory, pak slo≈æky
        const sortedChildren = filteredChildren.sort((a, b) => {
          const aIsIndex = a.name === 'index.html' || a.name === 'index.htm';
          const bIsIndex = b.name === 'index.html' || b.name === 'index.htm';
          
          // index.html m√° v≈ædy p≈ôednost
          if (aIsIndex && !bIsIndex) return -1;
          if (!aIsIndex && bIsIndex) return 1;
          
          // Soubory p≈ôed slo≈ækami (ale index.html u≈æ je vy≈ôe≈°en√Ω v√Ω≈°e)
          if (a.type === 'file' && b.type === 'directory') return -1;
          if (a.type === 'directory' && b.type === 'file') return 1;
          
          // Ostatn√≠ ≈ôazen√≠ abecednƒõ
          return a.name.localeCompare(b.name);
        });
        
        // Na ko≈ôenov√© √∫rovni (level 0) nezobrazovat slo≈æku, ale p≈ô√≠mo jej√≠ dƒõti
        if (level === 0) {
          return sortedChildren.map(child => renderTree(child, level + 1)).join('');
        }
        
        // Pro ostatn√≠ √∫rovnƒõ zobrazit slo≈æku norm√°lnƒõ
        const isExpanded = ''; // V≈°echny slo≈æky sbalen√© p≈ôi otev≈ôen√≠
        
        return `
          <div class="tree-item folder-item ${isExpanded}">
            <div class="file-item folder" data-folder="${node.path}">
              <span class="expand-icon">‚ñ∂</span>
              <span class="name">${node.name}</span>
            </div>
            <div class="tree-children">
              ${sortedChildren.map(child => renderTree(child, level + 1)).join('')}
            </div>
          </div>
        `;
      }
    }

    // Naƒç√≠st seznam soubor≈Ø
    async function loadFiles() {
      try {
        const response = await fetch('/api/files');
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error);
        }
        
        if (!data.tree || !data.tree.children || data.tree.children.length === 0) {
          fileList.innerHTML = `
            <div class="empty-state">
              <div class="icon">üìÑ</div>
              <p>Ve slo≈æce nebyly nalezeny ≈æ√°dn√© HTML soubory</p>
            </div>
          `;
          return;
        }
        
        const fileCount = countFiles(data.tree);
        fileList.innerHTML = `
          <h3>HTML Soubory (${fileCount})</h3>
          ${renderTree(data.tree)}
        `;
        
        // P≈ôidat event listenery pro soubory
        fileList.querySelectorAll('.file-item[data-path]').forEach(item => {
          item.addEventListener('click', (e) => {
            e.stopPropagation();
            openFile(item.dataset.path);
          });
        });
        
        // P≈ôidat event listenery pro slo≈æky (rozbalov√°n√≠/sbalov√°n√≠)
        fileList.querySelectorAll('.file-item[data-folder]').forEach(item => {
          item.addEventListener('click', (e) => {
            e.stopPropagation();
            const treeItem = item.closest('.tree-item');
            treeItem.classList.toggle('expanded');
          });
        });
        
      } catch (err) {
        fileList.innerHTML = `
          <div class="empty-state">
            <div class="icon">‚ö†Ô∏è</div>
            <p>${err.message}</p>
          </div>
        `;
      }
    }

    // Otev≈ô√≠t soubor v n√°hledu
    function openFile(path) {
      // Rozbalit v≈°echny nad≈ôazen√© slo≈æky
      const pathParts = path.split('/');
      for (let i = 1; i < pathParts.length; i++) {
        const folderPath = pathParts.slice(0, i).join('/');
        const folderItem = fileList.querySelector(`.file-item[data-folder="${folderPath}"]`);
        if (folderItem) {
          const treeItem = folderItem.closest('.tree-item');
          if (treeItem && !treeItem.classList.contains('expanded')) {
            treeItem.classList.add('expanded');
          }
        }
      }
      
      // Oznaƒçit aktivn√≠ soubor
      fileList.querySelectorAll('.file-item').forEach(item => {
        item.classList.remove('active');
      });
      
      const activeItem = fileList.querySelector(`.file-item[data-path="${path}"]`);
      if (activeItem) {
        activeItem.classList.add('active');
      }
      
      currentFile = path;
      currentFileEl.textContent = path;
      toolbar.style.display = 'flex';
      welcome.style.display = 'none';
      
      // Vytvo≈ôit iframe
      if (!iframe) {
        iframe = document.createElement('iframe');
        previewContainer.appendChild(iframe);
      }
      
      // Poƒçkat na naƒçten√≠ iframe a nastavit komunikaci
      iframe.onload = () => {
        setupToolbarCommunication();
      };
      
      iframe.src = `/preview/${path}`;
    }

    // Nastavit komunikaci s iframe pro toolbar
    function setupToolbarCommunication() {
      const editModeBtn = document.getElementById('edit-mode-btn-main');
      const saveBtn = document.getElementById('save-btn-main');
      const editStatus = document.getElementById('edit-status-main');
      
      if (!editModeBtn || !saveBtn || !iframe) return;
      
      // Poslouchat zpr√°vy z iframe
      function handleMessage(e) {
        if (e.data.type === 'text-editor-status') {
          if (e.data.editMode !== undefined) {
            editModeBtn.textContent = e.data.editMode ? '‚úì Edit m√≥d ON' : '‚úèÔ∏è Edit m√≥d';
            editModeBtn.classList.toggle('active', e.data.editMode);
          }
          if (e.data.status !== undefined) {
            editStatus.textContent = e.data.status;
            if (e.data.modified) {
              editStatus.classList.add('modified');
            } else {
              editStatus.classList.remove('modified');
            }
          }
        }
      }
      
      window.addEventListener('message', handleMessage);
      
      // Tlaƒç√≠tko Edit m√≥d
      editModeBtn.onclick = () => {
        iframe.contentWindow.postMessage({ type: 'text-editor-toggle-edit' }, '*');
      };
      
      // Tlaƒç√≠tko Ulo≈æit
      saveBtn.onclick = () => {
        iframe.contentWindow.postMessage({ type: 'text-editor-save' }, '*');
      };
    }

    // Event listenery
    loadBtn.addEventListener('click', setProject);
    
    folderInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') setProject();
    });

    // Naƒç√≠st p≈ôi startu
    loadCurrentProject();
  </script>
</body>
</html>

